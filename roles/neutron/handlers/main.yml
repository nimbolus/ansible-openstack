- name: init neutron db
  shell: | 
    su -s /bin/sh -c "neutron-db-manage --config-file /etc/neutron/neutron.conf \
      --config-file /etc/neutron/plugins/ml2/ml2_conf.ini upgrade head" neutron
  args:
    warn: false
  when: is_network_node

- name: restart neutron-server
  systemd:
    name: neutron-server
    state: restarted
  when: is_network_node

- name: restart neutron-dhcp-agent
  systemd:
    name: neutron-dhcp-agent
    state: restarted
  when: is_network_node

- name: restart neutron-metadata-agent
  systemd:
    name: neutron-metadata-agent
    state: restarted
  when: is_network_node

- name: restart neutron-l3-agent
  systemd:
    name: neutron-l3-agent
    state: restarted
  when: is_network_node or neutron_l3_ha

- name: restart neutron-linuxbridge-agent
  systemd:
    name: neutron-linuxbridge-agent
    state: restarted

- name: install selinux ha check script fix
  shell: |
    checkmodule -M -m -o /root/fix_neutron_ha_check_script.mod /root/fix_neutron_ha_check_script.te
    semodule_package -o /root/fix_neutron_ha_check_script.pp -m /root/fix_neutron_ha_check_script.mod
    semodule -i /root/fix_neutron_ha_check_script.pp
