- name: init database
  include_role:
    name: mariadb
    tasks_from: init_db.yml
  vars:
    db_name: keystone
    db_user: keystone
    db_user_password: "{{keystone_db_user_password}}"

- name: install
  yum:
    name:
    - openstack-keystone
    - httpd
    - mod_wsgi
    - mod_ssl

- name: configure
  template:
    src: keystone.conf.j2
    dest: /etc/keystone/keystone.conf
    backup: true
  notify: 
    - init keystone db
    - init keystone token provider
    - bootstrap keystone

- name: flush handlers
  meta: flush_handlers

- name: request certificate
  include_role:
    name: ca
    tasks_from: req_cert.yml
  vars:
    req_name: keystone
    req_common_name: "{{ansible_nodename}}"
    req_owner: apache
    req_group: apache

- name: configure httpd virtual host
  template:
    src: wsgi-keystone.conf.j2
    dest: /etc/httpd/conf.d/wsgi-keystone.conf
  notify: restart httpd

- name: flush handlers
  meta: flush_handlers

- name: create env file for debugging
  template:
    src: admin-openrc.j2
    dest: ~/admin-openrc
    mode: 0600
  become: false

- name: create service project
  os_project:
    auth: "{{keystone_admin_auth}}"
    name: service
    description: Service Project
    domain: default
