- name: init nova db
  shell: | 
    su -s /bin/sh -c "nova-manage api_db sync" nova
    su -s /bin/sh -c "nova-manage cell_v2 map_cell0" nova
    su -s /bin/sh -c "nova-manage cell_v2 create_cell --name=cell1 --verbose" nova
    su -s /bin/sh -c "nova-manage db sync" nova
  args:
    warn: false

- name: restart nova-api
  systemd:
    name: nova-api
    state: restarted
  when:  "'controller_nodes' in group_names"

- name: restart nova-scheduler
  systemd:
    name: nova-scheduler
    state: restarted
  when:  "'controller_nodes' in group_names"

- name: restart nova-conductor
  systemd:
    name: nova-conductor
    state: restarted
  when:  "'controller_nodes' in group_names"

- name: restart nova-novncproxy
  systemd:
    name: nova-novncproxy
    state: restarted
  when:  "'controller_nodes' in group_names"

- name: restart nova-compute
  systemd:
    name: nova-compute
    state: restarted
  when:  "'compute_nodes' in group_names"
